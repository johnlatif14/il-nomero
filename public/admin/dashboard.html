<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>لوحة التحكم - il-nomero</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              200: '#bae6fd',
              300: '#7dd3fc',
              400: '#38bdf8',
              500: '#0ea5e9',
              600: '#0284c7',
              700: '#0369a1',
              800: '#075985',
              900: '#0c4a6e',
            },
            clan: {
              dark: '#1a1a2e',
              primary: '#16213e',
              secondary: '#0f3460',
              accent: '#e94560',
              light: '#f9f9f9'
            }
          },
          fontFamily: {
            'tajawal': ['Tajawal', 'sans-serif']
          }
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');
    
    body {
      font-family: 'Tajawal', sans-serif;
    }
    
    .sidebar {
      transition: all 0.3s ease;
      background: linear-gradient(to bottom, #16213e, #0f3460);
    }
    
    .sidebar.collapsed {
      width: 80px;
    }
    
    .sidebar.collapsed .sidebar-text {
      display: none;
    }
    
    .sidebar.collapsed:hover {
      width: 260px;
    }
    
    .sidebar.collapsed:hover .sidebar-text {
      display: inline;
    }
    
    .main-content {
      transition: margin-right 0.3s ease;
    }
    
    .nav-item {
      transition: all 0.2s ease;
      border-right: 3px solid transparent;
    }
    
    .nav-item:hover {
      background-color: rgba(255, 255, 255, 0.1);
      border-right-color: #e94560;
    }
    
    .nav-item.active-tab {
      background-color: rgba(233, 69, 96, 0.2);
      border-right-color: #e94560;
    }
    
    .stat-card {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }
    
    .btn-primary {
      background-color: #e94560;
      transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
      background-color: #d13354;
      transform: translateY(-2px);
    }
    
    .btn-secondary {
      background-color: #0f3460;
      transition: all 0.3s ease;
    }
    
    .btn-secondary:hover {
      background-color: #0a2640;
      transform: translateY(-2px);
    }

    /* أنماط قسم الدرجات */
    .grade-excellent {
      background-color: rgba(34, 197, 94, 0.1);
      color: #16a34a;
    }

    .grade-good {
      background-color: rgba(234, 179, 8, 0.1);
      color: #ca8a04;
    }

    .grade-average {
      background-color: rgba(249, 115, 22, 0.1);
      color: #ea580c;
    }

    .grade-poor {
      background-color: rgba(239, 68, 68, 0.1);
      color: #dc2626;
    }

    .grade-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 0.375rem;
      font-weight: 600;
      font-size: 0.875rem;
    }
    
    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        z-index: 40;
        height: 100vh;
      }
      
      .sidebar.collapsed {
        width: 0;
        overflow: hidden;
      }
      
      .main-content {
        margin-right: 0 !important;
      }
    }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900">
  <div class="flex h-screen">
    <!-- الشريط الجانبي -->
    <div id="sidebar" class="sidebar text-white w-64 flex-shrink-0">
      <div class="p-4 flex items-center justify-between border-b border-gray-700">
        <a href="dashboard.html" class="flex items-center">
          <i class="fas fa-crown text-yellow-400 text-2xl"></i>
          <span class="sidebar-text text-xl font-bold mr-3 text-white">il-nomero</span>
        </a>
        <button id="toggleSidebar" class="text-gray-300 hover:text-white">
          <i class="fas fa-bars"></i>
        </button>
      </div>
      
      <nav class="p-4">
        <ul class="space-y-2">
          <li>
            <a href="#" class="nav-item flex items-center p-3 rounded active-tab" data-tab="dashboard">
              <i class="fas fa-tachometer-alt text-lg text-gray-300"></i>
              <span class="sidebar-text mr-4 text-gray-200">لوحة التحكم</span>
            </a>
          </li>
          <li>
            <a href="#" class="nav-item flex items-center p-3 rounded" data-tab="bookings">
              <i class="fas fa-users text-lg text-gray-300"></i>
              <span class="sidebar-text mr-4 text-gray-200">طلبات الانضمام</span>
            </a>
          </li>
          <li>
            <a href="#" class="nav-item flex items-center p-3 rounded" data-tab="messages">
              <i class="fas fa-envelope text-lg text-gray-300"></i>
              <span class="sidebar-text mr-4 text-gray-200">إرسال رسائل</span>
            </a>
          </li>
          <li>
            <a href="#" class="nav-item flex items-center p-3 rounded" data-tab="inquiries">
              <i class="fas fa-question-circle text-lg text-gray-300"></i>
              <span class="sidebar-text mr-4 text-gray-200">الاستفسارات</span>
            </a>
          </li>
          <li>
            <a href="#" class="nav-item flex items-center p-3 rounded" data-tab="results">
              <i class="fas fa-check-circle text-lg text-gray-300"></i>
              <span class="sidebar-text mr-4 text-gray-200">النتائج المعتمدة</span>
            </a>
          </li>
          <li>
            <a href="#" class="nav-item flex items-center p-3 rounded" data-tab="grades">
              <i class="fas fa-star text-lg text-gray-300"></i>
              <span class="sidebar-text mr-4 text-gray-200">الدرجات</span>
            </a>
          </li>
          <li>
            <a href="#" class="nav-item flex items-center p-3 rounded" data-tab="quizControl">
              <i class="fas fa-question text-lg text-gray-300"></i>
              <span class="sidebar-text mr-4 text-gray-200">الامتحان</span>
            </a>
          </li>
          <li class="border-t border-gray-700 pt-2 mt-2">
            <a href="/login.html" class="nav-item flex items-center p-3 rounded hover:bg-red-900/30" id="logoutBtn">
              <i class="fas fa-sign-out-alt text-lg text-red-400"></i>
              <span class="sidebar-text mr-4 text-red-400">تسجيل الخروج</span>
            </a>
          </li>
        </ul>
      </nav>
    </div>
    
    <!-- المحتوى الرئيسي -->
    <div class="main-content flex-1 overflow-auto bg-gray-50 dark:bg-gray-800">
      <!-- شريط العنوان -->
      <header class="bg-white dark:bg-gray-800 shadow-sm p-4 flex justify-between items-center sticky top-0 z-30">
        <div class="flex items-center">
          <button id="mobileToggleSidebar" class="mr-4 p-2 rounded-full bg-gray-200 dark:bg-gray-700 md:hidden">
            <i class="fas fa-bars text-gray-800 dark:text-white"></i>
          </button>
          <h1 class="text-xl font-bold text-gray-800 dark:text-white" id="pageTitle">لوحة التحكم</h1>
        </div>
        <div class="flex items-center space-x-4">
          <button id="toggleDarkMode" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white">
            <i class="fas fa-moon dark:hidden"></i>
            <i class="fas fa-sun hidden dark:inline"></i>
          </button>
          <div class="flex items-center bg-gray-100 dark:bg-gray-700 px-3 py-1 rounded-full">
            <img src="https://ui-avatars.com/api/?name=Admin&background=random" alt="Admin" class="w-8 h-8 rounded-full">
            <span class="mr-2 text-gray-800 dark:text-white">المدير</span>
          </div>
        </div>
      </header>
      
      <!-- المحتوى -->
      <main class="p-4">
        <!-- قسم لوحة التحكم -->
        <div id="dashboardTab" class="tab-content">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="stat-card bg-white dark:bg-gray-700 rounded-lg shadow p-6 border-t-4 border-indigo-500">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-500 dark:text-gray-400">طلبات الانضمام</p>
                  <h3 class="text-2xl font-bold text-gray-800 dark:text-white" id="totalBookings">0</h3>
                </div>
                <div class="p-3 rounded-full bg-indigo-100 dark:bg-indigo-900 text-indigo-600 dark:text-indigo-300">
                  <i class="fas fa-users text-xl"></i>
                </div>
              </div>
              <div class="mt-4">
                <a href="#" class="text-indigo-600 dark:text-indigo-400 hover:underline flex items-center" data-tab="bookings">
                  عرض الكل
                  <i class="fas fa-arrow-left mr-1"></i>
                </a>
              </div>
            </div>
            
            <div class="stat-card bg-white dark:bg-gray-700 rounded-lg shadow p-6 border-t-4 border-green-500">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-500 dark:text-gray-400">الاستفسارات الجديدة</p>
                  <h3 class="text-2xl font-bold text-gray-800 dark:text-white" id="newInquiries">0</h3>
                </div>
                <div class="p-3 rounded-full bg-green-100 dark:bg-green-900 text-green-600 dark:text-green-300">
                  <i class="fas fa-envelope text-xl"></i>
                </div>
              </div>
              <div class="mt-4">
                <a href="#" class="text-green-600 dark:text-green-400 hover:underline flex items-center" data-tab="inquiries">
                  عرض الكل
                  <i class="fas fa-arrow-left mr-1"></i>
                </a>
              </div>
            </div>
            
            <div class="stat-card bg-white dark:bg-gray-700 rounded-lg shadow p-6 border-t-4 border-blue-500">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-500 dark:text-gray-400">الطلبات المعتمدة</p>
                  <h3 class="text-2xl font-bold text-gray-800 dark:text-white" id="approvedResults">0</h3>
                </div>
                <div class="p-3 rounded-full bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300">
                  <i class="fas fa-check-circle text-xl"></i>
                </div>
              </div>
              <div class="mt-4">
                <a href="#" class="text-blue-600 dark:text-blue-400 hover:underline flex items-center" data-tab="results">
                  عرض الكل
                  <i class="fas fa-arrow-left mr-1"></i>
                </a>
              </div>
            </div>
          </div>
          
          <div class="bg-white dark:bg-gray-700 rounded-lg shadow overflow-hidden">
            <div class="p-4 border-b border-gray-200 dark:border-gray-600 flex justify-between items-center">
              <h2 class="text-xl font-bold text-gray-800 dark:text-white">آخر الطلبات</h2>
              <a href="#" class="text-sm text-indigo-600 dark:text-indigo-400 hover:underline" data-tab="bookings">عرض الكل</a>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
                <thead class="bg-gray-50 dark:bg-gray-600">
                  <tr>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الاسم</th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">رقم الهاتف</th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الفريمات</th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الحالة</th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">التاريخ</th>
                  </tr>
                </thead>
                <tbody id="recentBookings" class="bg-white dark:bg-gray-700 divide-y divide-gray-200 dark:divide-gray-600">
                  <!-- سيتم ملؤه بالبيانات -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- قسم طلبات الانضمام -->
        <div id="bookingsTab" class="tab-content hidden">
          <div class="bg-white dark:bg-gray-700 rounded-lg shadow overflow-hidden">
            <div class="p-4 border-b border-gray-200 dark:border-gray-600 flex justify-between items-center">
              <h2 class="text-xl font-bold text-gray-800 dark:text-white">طلبات الانضمام</h2>
              <div class="flex space-x-2">
                <select id="bookingFilter" class="border border-gray-300 dark:border-gray-600 rounded px-3 py-1 bg-white dark:bg-gray-800 text-sm">
                  <option value="all">الكل</option>
                  <option value="pending">قيد الانتظار</option>
                  <option value="approved">مقبولة</option>
                  <option value="rejected">مرفوضة</option>
                </select>
                <button class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded text-sm">
                  <i class="fas fa-plus mr-1"></i> جديد
                </button>
              </div>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
                <thead class="bg-gray-50 dark:bg-gray-600">
                  <tr>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الاسم</th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">البريد</th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الهاتف</th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الفريمات</th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">السن</th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الحالة</th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الإجراءات</th>
                  </tr>
                </thead>
                <tbody id="bookingsTable" class="bg-white dark:bg-gray-700 divide-y divide-gray-200 dark:divide-gray-600">
                  <!-- سيتم ملؤه بالبيانات -->
                </tbody>
              </table>
            </div>
            <div class="p-4 border-t border-gray-200 dark:border-gray-600 flex justify-between items-center">
              <div class="text-sm text-gray-500 dark:text-gray-400">
                عرض <span id="bookingsCount">0</span> من <span id="totalBookingsCount">0</span> طلب
              </div>
              <div class="flex space-x-2">
                <button class="px-3 py-1 border border-gray-300 dark:border-gray-600 rounded text-sm disabled:opacity-50" disabled>
                  السابق
                </button>
                <button class="px-3 py-1 bg-indigo-600 text-white rounded text-sm hover:bg-indigo-700">
                  التالي
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- قسم إرسال الرسائل -->
        <div id="messagesTab" class="tab-content hidden">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white dark:bg-gray-700 rounded-lg shadow overflow-hidden">
              <div class="p-4 border-b border-gray-200 dark:border-gray-600">
                <h2 class="text-xl font-bold text-gray-800 dark:text-white">إرسال رسالة إلى اللاعب</h2>
              </div>
              <div class="p-4">
                <form id="sendMessageForm">
                  <div class="mb-4">
                    <label class="block text-gray-700 dark:text-gray-300 mb-2">البريد الإلكتروني للاعب</label>
                    <input type="email" id="playerEmail" class="w-full border border-gray-300 dark:border-gray-600 rounded px-3 py-2 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                  </div>
                  <div class="mb-4">
                    <label class="block text-gray-700 dark:text-gray-300 mb-2">اسم المرسل (اختياري)</label>
                    <input type="text" id="senderName" class="w-full border border-gray-300 dark:border-gray-600 rounded px-3 py-2 bg-white dark:bg-gray-700" placeholder="STORE King个ESPORTSツ">
                  </div>
                  <div class="mb-4">
                    <label class="block text-gray-700 dark:text-gray-300 mb-2">الرسالة</label>
                    <textarea id="messageContent" rows="5" class="w-full border border-gray-300 dark:border-gray-600 rounded px-3 py-2 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required></textarea>
                  </div>
                  <button type="submit" class="btn-primary text-white py-2 px-4 rounded">
                    <i class="fas fa-paper-plane mr-2"></i> إرسال الرسالة
                  </button>
                </form>
                <div id="messageResponse" class="mt-4 hidden"></div>
              </div>
            </div>

            <div class="bg-white dark:bg-gray-700 rounded-lg shadow overflow-hidden">
              <div class="p-4 border-b border-gray-200 dark:border-gray-600">
                <h2 class="text-xl font-bold text-gray-800 dark:text-white">رفع نتيجة اللاعب</h2>
              </div>
              <div class="p-4">
                <form id="uploadResultForm" enctype="multipart/form-data">
                  <div class="mb-4">
                    <label class="block text-gray-700 dark:text-gray-300 mb-2">رقم هاتف اللاعب</label>
                    <input type="tel" id="playerPhone" class="w-full border border-gray-300 dark:border-gray-600 rounded px-3 py-2 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                  </div>
                  <div class="mb-4">
                    <label class="block text-gray-700 dark:text-gray-300 mb-2">اسم اللاعب (اختياري)</label>
                    <input type="text" id="playerName" class="w-full border border-gray-300 dark:border-gray-600 rounded px-3 py-2 bg-white dark:bg-gray-700">
                  </div>
                  <div class="mb-4">
                    <label class="block text-gray-700 dark:text-gray-300 mb-2">ملف النتيجة</label>
                    <div class="mt-1 flex items-center">
                      <label for="resultFile" class="cursor-pointer bg-gray-100 dark:bg-gray-600 hover:bg-gray-200 dark:hover:bg-gray-500 px-4 py-2 rounded border border-gray-300 dark:border-gray-600">
                        <i class="fas fa-cloud-upload-alt mr-2"></i> اختر ملف
                        <input type="file" id="resultFile" name="resultFile" class="hidden" accept=".pdf,.jpg,.jpeg,.png" required>
                      </label>
                      <span id="fileName" class="mr-3 text-sm text-gray-500 dark:text-gray-400 truncate max-w-xs">لم يتم اختيار ملف</span>
                    </div>
                  </div>
                  <button type="submit" class="btn-secondary text-white py-2 px-4 rounded">
                    <i class="fas fa-upload mr-2"></i> رفع النتيجة
                  </button>
                </form>
                <div id="uploadResponse" class="mt-4 hidden"></div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- قسم الاستفسارات -->
        <div id="inquiriesTab" class="tab-content hidden">
          <div class="bg-white dark:bg-gray-700 rounded-lg shadow overflow-hidden">
            <div class="p-4 border-b border-gray-200 dark:border-gray-600 flex justify-between items-center">
              <h2 class="text-xl font-bold text-gray-800 dark:text-white">الاستفسارات</h2>
              <div class="flex space-x-2">
                <select id="inquiryFilter" class="border border-gray-300 dark:border-gray-600 rounded px-3 py-1 bg-white dark:bg-gray-800 text-sm">
                  <option value="all">الكل</option>
                  <option value="new">جديدة</option>
                  <option value="responded">تم الرد</option>
                </select>
                <button class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded text-sm">
                  <i class="fas fa-filter mr-1"></i> تصفية
                </button>
              </div>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
                <thead class="bg-gray-50 dark:bg-gray-600">
                  <tr>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الاسم</th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">البريد</th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الهاتف</th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الرسالة</th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الحالة</th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الإجراءات</th>
                  </tr>
                </thead>
                <tbody id="inquiriesTable" class="bg-white dark:bg-gray-700 divide-y divide-gray-200 dark:divide-gray-600">
                  <!-- سيتم ملؤه بالبيانات -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- قسم النتائج المعتمدة -->
        <div id="resultsTab" class="tab-content hidden">
          <div class="bg-white dark:bg-gray-700 rounded-lg shadow overflow-hidden">
            <div class="p-4 border-b border-gray-200 dark:border-gray-600 flex justify-between items-center">
              <h2 class="text-xl font-bold text-gray-800 dark:text-white">النتائج المعتمدة</h2>
              <button class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded text-sm">
                <i class="fas fa-plus mr-1"></i> إضافة نتيجة
              </button>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
                <thead class="bg-gray-50 dark:bg-gray-600">
                  <tr>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الاسم</th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">رقم الهاتف</th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">تاريخ القبول</th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الإجراءات</th>
                  </tr>
                </thead>
                <tbody id="resultsTable" class="bg-white dark:bg-gray-700 divide-y divide-gray-200 dark:divide-gray-600">
                  <!-- سيتم ملؤه بالبيانات -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- قسم الدرجات -->
        <div id="gradesTab" class="tab-content hidden">
          <div class="bg-white dark:bg-gray-700 rounded-lg shadow overflow-hidden">
            <div class="p-4 border-b border-gray-200 dark:border-gray-600 flex justify-between items-center">
              <h2 class="text-xl font-bold text-gray-800 dark:text-white">سجل الدرجات</h2>
              <div class="flex space-x-2">
                <button id="addGradeBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded text-sm">
                  <i class="fas fa-plus mr-1"></i> إضافة درجة
                </button>
                <button id="exportGradesBtn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                  <i class="fas fa-file-export mr-1"></i> تصدير البيانات
                </button>
              </div>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
                <thead class="bg-gray-50 dark:bg-gray-600">
                  <tr>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">#</th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">اسم الشخص</th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الدرجة</th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">رقم الهاتف</th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">البريد الإلكتروني</th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">التاريخ</th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الإجراءات</th>
                  </tr>
                </thead>
                <tbody id="gradesTable" class="bg-white dark:bg-gray-700 divide-y divide-gray-200 dark:divide-gray-600">
                  <!-- سيتم ملؤه بالبيانات -->
                  <tr>
                    <td colspan="7" class="px-4 py-4 text-center text-gray-500 dark:text-gray-400">لا توجد بيانات متاحة</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="p-4 border-t border-gray-200 dark:border-gray-600 flex justify-between items-center">
              <div class="text-sm text-gray-500 dark:text-gray-400">
                عرض <span id="gradesCount">0</span> من <span id="totalGradesCount">0</span> نتيجة
              </div>
              <div class="flex space-x-2">
                <button class="px-3 py-1 border border-gray-300 dark:border-gray-600 rounded text-sm disabled:opacity-50" disabled>
                  السابق
                </button>
                <button class="px-3 py-1 bg-indigo-600 text-white rounded text-sm hover:bg-indigo-700">
                  التالي
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- قسم الامتحان -->
        <div id="quizControlTab" class="tab-content hidden">
          <div class="bg-white dark:bg-gray-700 rounded-lg shadow overflow-hidden">
            <div class="p-4 border-b border-gray-200 dark:border-gray-600">
              <h2 class="text-xl font-bold text-gray-800 dark:text-white">التحكم في الامتحان</h2>
            </div>
            <div class="p-4">
              <p class="text-gray-700 dark:text-gray-300 mb-4">
                حالة الامتحان الحالية: <span id="quizStatus" class="font-bold">جاري التحميل...</span>
              </p>
              <div class="flex space-x-4 space-x-reverse">
                <button id="openQuizBtn" class="btn-primary text-white py-2 px-4 rounded">
                  <i class="fas fa-play-circle mr-2"></i> فتح الامتحان
                </button>
                <button id="closeQuizBtn" class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded">
                  <i class="fas fa-pause-circle mr-2"></i> إغلاق الامتحان
                </button>
              </div>
              <div id="quizControlResponse" class="mt-4 hidden"></div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Modal لتعديل حالة الطلب -->
  <div id="editBookingModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md">
      <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
        <h3 class="text-lg font-bold text-gray-800 dark:text-white">تعديل حالة الطلب</h3>
        <button id="closeBookingModal" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="p-4">
        <form id="editBookingForm">
          <input type="hidden" id="editBookingId">
          <div class="mb-4">
            <label class="block text-gray-700 dark:text-gray-300 mb-2">الحالة</label>
            <select id="editBookingStatus" class="w-full border border-gray-300 dark:border-gray-600 rounded px-3 py-2 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
              <option value="pending">قيد الانتظار</option>
              <option value="approved">مقبول</option>
              <option value="rejected">مرفوض</option>
            </select>
          </div>
          <div class="mb-4">
            <label class="block text-gray-700 dark:text-gray-300 mb-2">ملاحظات</label>
            <textarea id="editBookingNotes" rows="3" class="w-full border border-gray-300 dark:border-gray-600 rounded px-3 py-2 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
          </div>
          <div class="flex justify-end space-x-2">
            <button type="button" id="cancelBookingEdit" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">إلغاء</button>
            <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">حفظ</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal للرد على الاستفسار -->
  <div id="respondInquiryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md">
      <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
        <h3 class="text-lg font-bold text-gray-800 dark:text-white">الرد على الاستفسار</h3>
        <button id="closeInquiryModal" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="p-4">
        <form id="respondInquiryForm">
          <input type="hidden" id="respondInquiryId">
          <div class="mb-4">
            <label class="block text-gray-700 dark:text-gray-300 mb-2">الرد</label>
            <textarea id="inquiryResponse" rows="4" class="w-full border border-gray-300 dark:border-gray-600 rounded px-3 py-2 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
          </div>
          <div class="flex justify-end space-x-2">
            <button type="button" id="cancelInquiryResponse" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">إلغاء</button>
            <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">إرسال الرد</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal لتعديل النتيجة -->
  <div id="editResultModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md">
      <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
        <h3 class="text-lg font-bold text-gray-800 dark:text-white">تعديل النتيجة</h3>
        <button id="closeResultModal" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="p-4">
       <form id="editResultForm" enctype="multipart/form-data">
          <input type="hidden" id="editResultId" name="id">
          <div class="mb-4">
            <label class="block text-gray-700 dark:text-gray-300 mb-2">رقم هاتف اللاعب *</label>
            <input type="tel" id="editPlayerPhone" name="playerPhone" class="w-full border border-gray-300 dark:border-gray-600 rounded px-3 py-2 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
          </div>
          <div class="mb-4">
            <label class="block text-gray-700 dark:text-gray-300 mb-2">اسم اللاعب (اختياري)</label>
            <input type="text" id="editPlayerName" class="w-full border border-gray-300 dark:border-gray-600 rounded px-3 py-2 bg-white dark:bg-gray-700">
          </div>
          <div class="mb-4">
            <label class="block text-gray-700 dark:text-gray-300 mb-2">ملف النتيجة الجديدة (اختياري)</label>
            <div class="mt-1 flex items-center">
              <label for="editResultFile" class="cursor-pointer bg-gray-100 dark:bg-gray-600 hover:bg-gray-200 dark:hover:bg-gray-500 px-4 py-2 rounded border border-gray-300 dark:border-gray-600">
                <i class="fas fa-cloud-upload-alt mr-2"></i> اختر ملف
                <input type="file" id="editResultFile" name="editResultFile" class="hidden" accept=".pdf,.jpg,.jpeg,.png">
              </label>
              <span id="editFileName" class="mr-3 text-sm text-gray-500 dark:text-gray-400 truncate max-w-xs">لم يتم اختيار ملف</span>
            </div>
          </div>
          <div class="flex justify-end space-x-2">
            <button type="button" id="cancelResultEdit" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">إلغاء</button>
            <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">حفظ التعديلات</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal لحذف الطلب -->
  <div id="deleteBookingModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md">
      <div class="p-4 border-b border-gray-200 dark:border-gray-700">
        <h3 class="text-lg font-bold text-gray-800 dark:text-white">حذف الطلب</h3>
      </div>
      <div class="p-4">
        <p class="text-gray-700 dark:text-gray-300 mb-4">هل أنت متأكد من حذف هذا الطلب؟</p>
        <input type="hidden" id="deleteBookingId">
        <div class="flex justify-end space-x-2">
          <button type="button" id="cancelDeleteBooking" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">إلغاء</button>
          <button type="button" id="confirmDeleteBooking" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">حذف</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal لحذف الاستفسار -->
  <div id="deleteInquiryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md">
      <div class="p-4 border-b border-gray-200 dark:border-gray-700">
        <h3 class="text-lg font-bold text-gray-800 dark:text-white">حذف الاستفسار</h3>
      </div>
      <div class="p-4">
        <p class="text-gray-700 dark:text-gray-300 mb-4">هل أنت متأكد من حذف هذا الاستفسار؟</p>
        <input type="hidden" id="deleteInquiryId">
        <div class="flex justify-end space-x-2">
          <button type="button" id="cancelDeleteInquiry" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">إلغاء</button>
          <button type="button" id="confirmDeleteInquiry" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">حذف</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal لإضافة/تعديل الدرجات -->
  <div id="gradeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md">
      <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
        <h3 class="text-lg font-bold text-gray-800 dark:text-white" id="gradeModalTitle">إضافة درجة جديدة</h3>
        <button id="closeGradeModal" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="p-4">
        <form id="gradeForm">
          <input type="hidden" id="gradeId">
          <div class="mb-4">
            <label class="block text-gray-700 dark:text-gray-300 mb-2">اسم الشخص *</label>
            <input type="text" id="studentName" class="w-full border border-gray-300 dark:border-gray-600 rounded px-3 py-2 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
          </div>
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block text-gray-700 dark:text-gray-300 mb-2">الدرجة *</label>
              <input type="number" id="grade" class="w-full border border-gray-300 dark:border-gray-600 rounded px-3 py-2 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
            </div>
            <div>
              <label class="block text-gray-700 dark:text-gray-300 mb-2">من *</label>
              <input type="number" id="total" class="w-full border border-gray-300 dark:border-gray-600 rounded px-3 py-2 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
            </div>
          </div>
          <div class="mb-4">
            <label class="block text-gray-700 dark:text-gray-300 mb-2">رقم الهاتف *</label>
            <input type="tel" id="studentPhone" class="w-full border border-gray-300 dark:border-gray-600 rounded px-3 py-2 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
          </div>
          <div class="mb-4">
            <label class="block text-gray-700 dark:text-gray-300 mb-2">البريد الإلكتروني</label>
            <input type="email" id="studentEmail" class="w-full border border-gray-300 dark:border-gray-600 rounded px-3 py-2 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
          </div>
          <div class="flex justify-end space-x-2">
            <button type="button" id="cancelGrade" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">إلغاء</button>
            <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">حفظ</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    console.log('Page elements:', {
      pageTitle: document.getElementById('pageTitle'),
      resultsTable: document.getElementById('resultsTable'),
      tabs: document.querySelectorAll('[data-tab]')
    });
  });

  async function checkSession() {
    try {
      const response = await fetch('/admin/check-session');
      const data = await response.json();
      
      if (!data.loggedIn) {
        window.location.href = '/login.html'; // تم تغيير المسار هنا
      } else {
        loadData();
        checkQuizStatus(); // استدعاء دالة التحقق من حالة الامتحان
      }
    } catch (error) {
      console.error('Error checking session:', error);
      window.location.href = '/login.html'; // تم تغيير المسار هنا
    }
  }

  async function loadData() {
    try {
      const response = await fetch('/admin/data');
      const data = await response.json();
      
      document.getElementById('totalBookings').textContent = data.bookings.length;
      document.getElementById('newInquiries').textContent = data.inquiries.filter(i => i.status === 'new').length;
      document.getElementById('approvedResults').textContent = data.results.length;
      
      const recentBookings = data.bookings.slice(0, 5);
      const recentBookingsHtml = recentBookings.map(booking => `
        <tr>
          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200">${booking.name}</td>
          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200">${booking.phone}</td>
          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200">${booking.duration || 'غير متوفر'}</td>
          <td class="px-4 py-3 whitespace-nowrap text-sm">
            <span class="px-2 py-1 rounded-full text-xs ${getStatusClass(booking.status)}">
              ${getStatusText(booking.status)}
            </span>
          </td>
          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200">
            ${new Date(booking.createdAt).toLocaleDateString('ar-EG')}
          </td>
        </tr>
      `).join('');
      document.getElementById('recentBookings').innerHTML = recentBookingsHtml;
      
      renderBookingsTable(data.bookings);
      renderInquiriesTable(data.inquiries);
      renderResultsTable(data.results);
      updateGradesTable(data.quizzes); // تحديث جدول الدرجات ببيانات الاختبارات
      
    } catch (error) {
      console.error('Error loading data:', error);
      showError('حدث خطأ أثناء تحميل البيانات، يرجى المحاولة مرة أخرى');
    }
  }
  
  function renderBookingsTable(bookings) {
    const filter = document.getElementById('bookingFilter').value;
    let filteredBookings = bookings;
    
    if (filter !== 'all') {
      filteredBookings = bookings.filter(b => b.status === filter);
    }
    
    const bookingsHtml = filteredBookings.map(booking => `
      <tr>
        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200">${booking.name}</td>
        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200">${booking.email}</td>
        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200">${booking.phone}</td>
        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200">${booking.duration || 'غير متوفر'}</td>
        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200">${booking.age || 'غير متوفر'}</td>
        <td class="px-4 py-3 whitespace-nowrap text-sm">
          <span class="px-2 py-1 rounded-full text-xs ${getStatusClass(booking.status)}">
            ${getStatusText(booking.status)}
          </span>
        </td>
        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200">
          <button class="edit-booking p-1 text-indigo-600 dark:text-indigo-400 hover:text-indigo-900 dark:hover:text-indigo-300 mr-2" 
                  data-id="${booking.id}" data-status="${booking.status}" data-notes="${booking.notes || ''}">
            <i class="fas fa-edit"></i>
          </button>
          <button class="delete-booking p-1 text-red-600 dark:text-red-400 hover:text-red-900 dark:hover:text-red-300 mr-2" 
                  data-id="${booking.id}">
            <i class="fas fa-trash"></i>
          </button>
          ${booking.gameVideo ? `
            <span class="mx-1 text-gray-400">|</span>
            <a href="${booking.gameVideo}" target="_blank" class="p-1 text-blue-600 dark:text-blue-400 hover:text-blue-900 dark:hover:text-blue-300" title="عرض الفيديو">
              <i class="fas fa-eye"></i>
            </a>
            <a href="${booking.gameVideo}" download class="p-1 text-green-600 dark:text-green-400 hover:text-green-900 dark:hover:text-green-300" title="تحميل الفيديو">
              <i class="fas fa-download"></i>
            </a>
          ` : ''}
        </td>
      </tr>
    `).join('');
    
    document.getElementById('bookingsTable').innerHTML = bookingsHtml;
    document.getElementById('bookingsCount').textContent = filteredBookings.length;
    document.getElementById('totalBookingsCount').textContent = bookings.length;
    
    document.querySelectorAll('.edit-booking').forEach(button => {
      button.addEventListener('click', () => {
        const id = button.getAttribute('data-id');
        const status = button.getAttribute('data-status');
        const notes = button.getAttribute('data-notes');
        
        document.getElementById('editBookingId').value = id;
        document.getElementById('editBookingStatus').value = status;
        document.getElementById('editBookingNotes').value = notes;
        
        document.getElementById('editBookingModal').classList.remove('hidden');
      });
    });
    
    document.querySelectorAll('.delete-booking').forEach(button => {
      button.addEventListener('click', () => {
        const id = button.getAttribute('data-id');
        document.getElementById('deleteBookingId').value = id;
        document.getElementById('deleteBookingModal').classList.remove('hidden');
      });
    });
  }
  
  function renderInquiriesTable(inquiries) {
    const filter = document.getElementById('inquiryFilter').value;
    let filteredInquiries = inquiries;
    
    if (filter !== 'all') {
      filteredInquiries = inquiries.filter(i => 
        filter === 'new' ? i.status === 'new' : i.status !== 'new'
      );
    }
    
    const inquiriesHtml = filteredInquiries.map(inquiry => `
      <tr>
        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200">${inquiry.name}</td>
        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200">${inquiry.email}</td>
        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200">${inquiry.phone}</td>
        <td class="px-4 py-3 text-sm text-gray-800 dark:text-gray-200">
          <div class="max-w-xs truncate">${inquiry.message}</div>
        </td>
        <td class="px-4 py-3 whitespace-nowrap text-sm">
          <span class="px-2 py-1 rounded-full text-xs ${inquiry.status === 'new' ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200' : 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200'}">
            ${inquiry.status === 'new' ? 'جديد' : 'تم الرد'}
          </span>
        </td>
        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200">
          ${inquiry.status === 'new' ? `
            <button class="respond-inquiry p-1 text-green-600 dark:text-green-400 hover:text-green-900 dark:hover:text-green-300 mr-2" 
                    data-id="${inquiry.id}">
              <i class="fas fa-reply"></i>
            </button>
          ` : ''}
          <button class="delete-inquiry p-1 text-red-600 dark:text-red-400 hover:text-red-900 dark:hover:text-red-300 mr-2" 
                  data-id="${inquiry.id}">
            <i class="fas fa-trash"></i>
          </button>
          ${inquiry.response ? `
            <button class="view-response p-1 text-blue-600 dark:text-blue-400 hover:text-blue-900 dark:hover:text-blue-300" 
                    data-response="${inquiry.response}">
              <i class="fas fa-eye"></i>
            </button>
          ` : ''}
        </td>
      </tr>
    `).join('');
    
    document.getElementById('inquiriesTable').innerHTML = inquiriesHtml;
    
    document.querySelectorAll('.respond-inquiry').forEach(button => {
      button.addEventListener('click', () => {
        const id = button.getAttribute('data-id');
        document.getElementById('respondInquiryId').value = id;
        document.getElementById('respondInquiryModal').classList.remove('hidden');
      });
    });
    
    document.querySelectorAll('.view-response').forEach(button => {
      button.addEventListener('click', () => {
        const response = button.getAttribute('data-response');
        alert('الرد:\n\n' + response);
      });
    });
    
    document.querySelectorAll('.delete-inquiry').forEach(button => {
      button.addEventListener('click', () => {
        const id = button.getAttribute('data-id');
        document.getElementById('deleteInquiryId').value = id;
        document.getElementById('deleteInquiryModal').classList.remove('hidden');
      });
    });
  }
  
  function renderResultsTable(results) {
    const resultsTable = document.getElementById('resultsTable');
    
    if (!results || !Array.isArray(results)) {
      resultsTable.innerHTML = `
        <tr>
          <td colspan="4" class="text-center py-4 text-red-500">
            خطأ في تحميل النتائج
          </td>
        </tr>
      `;
      return;
    }

    if (results.length === 0) {
      resultsTable.innerHTML = `
        <tr>
          <td colspan="4" class="text-center py-4 text-gray-500">
            لا توجد نتائج معتمدة حتى الآن
          </td>
        </tr>
      `;
      return;
    }

    const resultsHtml = results.map(result => {
      const playerName = result.playerName || 'غير معروف';
      const playerPhone = result.playerPhone || 'غير متوفر';
      const uploadedAt = result.uploadedAt ? new Date(result.uploadedAt).toLocaleDateString('ar-EG') : 'غير معروف';
      
      return `
        <tr>
          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200">${playerName}</td>
          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200">${playerPhone}</td>
          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200">${uploadedAt}</td>
          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200">
            ${result.fileUrl ? `
              <a href="${result.fileUrl}" target="_blank" class="text-blue-600 dark:text-blue-400 hover:underline mr-2">
                <i class="fas fa-eye"></i> عرض
              </a>
            ` : ''}
            <button class="edit-result p-1 text-yellow-600 dark:text-yellow-400 hover:text-yellow-900 dark:hover:text-yellow-300 mr-2" 
                    data-id="${result.id}" data-phone="${playerPhone}" data-name="${playerName}">
              <i class="fas fa-edit"></i> تعديل
            </button>
            <button class="delete-result p-1 text-red-600 dark:text-red-400 hover:text-red-900 dark:hover:text-red-300" 
                    data-id="${result.id}">
              <i class="fas fa-trash"></i> حذف
            </button>
          </td>
        </tr>
      `;
    }).join('');
    
    resultsTable.innerHTML = resultsHtml;
    bindResultEvents();
  }

  function bindResultEvents() {
    document.querySelectorAll('.edit-result').forEach(button => {
      button.addEventListener('click', (e) => {
        const id = button.getAttribute('data-id');
        const phone = button.getAttribute('data-phone');
        const name = button.getAttribute('data-name');
        
        document.getElementById('editResultId').value = id;
        document.getElementById('editPlayerPhone').value = phone;
        document.getElementById('editPlayerName').value = name || '';
        
        document.getElementById('editResultModal').classList.remove('hidden');
      });
    });
    
    document.querySelectorAll('.delete-result').forEach(button => {
      button.addEventListener('click', handleDeleteResult);
    });
  }

  async function handleDeleteResult(e) {
    const id = e.currentTarget.getAttribute('data-id');
    if (confirm('هل أنت متأكد من حذف هذه النتيجة؟')) {
      try {
        const response = await fetch(`/admin/delete-result/${id}`, {
          method: 'DELETE'
        });
        const data = await response.json();
        
        if (data.success) {
          showSuccess('تم حذف النتيجة بنجاح');
          loadData();
        } else {
          showError(data.message || 'حدث خطأ أثناء حذف النتيجة');
        }
      } catch (error) {
        console.error('Error deleting result:', error);
        showError('حدث خطأ أثناء حذف النتيجة');
      }
    }
  }
  
  function getStatusClass(status) {
    switch(status) {
      case 'approved': return 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
      case 'rejected': return 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
      default: return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
    }
  }
  
  function getStatusText(status) {
    switch(status) {
      case 'approved': return 'مقبول';
      case 'rejected': return 'مرفوض';
      default: return 'قيد الانتظار';
    }
  }
  
  function showSuccess(message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg z-50';
    alertDiv.textContent = message;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
      alertDiv.remove();
    }, 3000);
  }
  
  function showError(message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded shadow-lg z-50';
    alertDiv.textContent = message;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
      alertDiv.remove();
    }, 3000);
  }
  
  document.getElementById('toggleDarkMode').addEventListener('click', () => {
    document.documentElement.classList.toggle('dark');
    localStorage.setItem('darkMode', document.documentElement.classList.contains('dark'));
  });
  
  if (localStorage.getItem('darkMode') === 'true') {
    document.documentElement.classList.add('dark');
  }
  
  function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.querySelector('.main-content');
    
    sidebar.classList.toggle('collapsed');
    
    if (window.innerWidth > 768) {
      if (sidebar.classList.contains('collapsed')) {
        mainContent.classList.remove('mr-64');
        mainContent.classList.add('mr-20');
      } else {
        mainContent.classList.remove('mr-20');
        mainContent.classList.add('mr-64');
      }
    }
  }
  
  document.getElementById('toggleSidebar').addEventListener('click', toggleSidebar);
  document.getElementById('mobileToggleSidebar').addEventListener('click', toggleSidebar);
  
  document.querySelectorAll('[data-tab]').forEach(tab => {
    tab.addEventListener('click', (e) => {
      e.preventDefault();
      const tabId = tab.getAttribute('data-tab');
      
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
      });
      
      document.querySelectorAll('.nav-item').forEach(t => { // تم تغيير المحدد هنا
        t.classList.remove('active-tab');
        t.classList.remove('bg-gray-700');
      });
      
      document.getElementById(`${tabId}Tab`).classList.remove('hidden');
      
      tab.classList.add('active-tab');
      tab.classList.add('bg-gray-700');
      
      const tabTextElement = tab.querySelector('.sidebar-text');
      if (tabTextElement) {
        const pageTitleElement = document.getElementById('pageTitle');
        if (pageTitleElement) {
          pageTitleElement.textContent = tabTextElement.textContent.trim();
        }
      }
      
      // تحديث حالة الامتحان عند التبديل إلى تبويب التحكم في الامتحان
      if (tabId === 'quizControl') {
        checkQuizStatus();
      }
    });
  });
  
  document.getElementById('bookingFilter').addEventListener('change', () => {
    loadData();
  });
  
  document.getElementById('inquiryFilter').addEventListener('change', () => {
    loadData();
  });
  
  document.getElementById('editBookingForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const id = document.getElementById('editBookingId').value;
    const status = document.getElementById('editBookingStatus').value;
    const notes = document.getElementById('editBookingNotes').value;
    
    try {
      const response = await fetch(`/admin/update-booking/${id}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ status, notes })
      });
      
      const data = await response.json();
      
      if (data.success) {
        document.getElementById('editBookingModal').classList.add('hidden');
        showSuccess('تم تحديث حالة الطلب بنجاح');
        loadData();
      } else {
        showError(data.message || 'حدث خطأ أثناء حفظ التعديلات');
      }
    } catch (error) {
      console.error('Error updating booking:', error);
      showError('حدث خطأ أثناء حفظ التعديلات');
    }
  });
  
  document.getElementById('sendMessageForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const email = document.getElementById('playerEmail').value;
    const message = document.getElementById('messageContent').value;
    const senderName = document.getElementById('senderName').value || 'STORE King个ESPORTSツ';
    
    try {
      const response = await fetch('/admin/send-message', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ email, message, senderName })
      });
      
      const data = await response.json();
      
      const responseDiv = document.getElementById('messageResponse');
      responseDiv.classList.remove('hidden');
      
      if (data.success) {
        responseDiv.innerHTML = `
          <div class="bg-green-100 dark:bg-green-900 border border-green-400 dark:border-green-700 text-green-700 dark:text-green-200 px-4 py-3 rounded">
            ${data.message}
          </div>
        `;
        document.getElementById('sendMessageForm').reset();
        showSuccess('تم إرسال الرسالة بنجاح');
      } else {
        responseDiv.innerHTML = `
          <div class="bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-700 text-red-700 dark:text-red-200 px-4 py-3 rounded">
            ${data.message}
          </div>
        `;
        showError(data.message || 'حدث خطأ أثناء إرسال الرسالة');
      }
    } catch (error) {
      console.error('Error sending message:', error);
      const responseDiv = document.getElementById('messageResponse');
      responseDiv.classList.remove('hidden');
      responseDiv.innerHTML = `
        <div class="bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-700 text-red-700 dark:text-red-200 px-4 py-3 rounded">
          حدث خطأ أثناء إرسال الرسالة
        </div>
      `;
      showError('حدث خطأ أثناء إرسال الرسالة');
    }
  });

  document.getElementById('uploadResultForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData();
    formData.append('playerPhone', document.getElementById('playerPhone').value);
    formData.append('playerName', document.getElementById('playerName').value);
    formData.append('resultFile', document.getElementById('resultFile').files[0]);
    
    try {
      const response = await fetch('/admin/upload-result', {
        method: 'POST',
        body: formData
      });
      
      const data = await response.json();
      
      const responseDiv = document.getElementById('uploadResponse');
      responseDiv.classList.remove('hidden');
      
      if (data.success) {
        responseDiv.innerHTML = `
          <div class="bg-green-100 dark:bg-green-900 border border-green-400 dark:border-green-700 text-green-700 dark:text-green-200 px-4 py-3 rounded">
            ${data.message}
          </div>
        `;
        document.getElementById('uploadResultForm').reset();
        showSuccess('تم رفع النتيجة بنجاح');
        loadData();
      } else {
        responseDiv.innerHTML = `
          <div class="bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-700 text-red-700 dark:text-red-200 px-4 py-3 rounded">
            ${data.message}
          </div>
        `;
        showError(data.message || 'حدث خطأ أثناء رفع الملف');
      }
    } catch (error) {
      console.error('Error uploading result:', error);
      const responseDiv = document.getElementById('uploadResponse');
      responseDiv.classList.remove('hidden');
      responseDiv.innerHTML = `
        <div class="bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-700 text-red-700 dark:text-red-200 px-4 py-3 rounded">
          حدث خطأ أثناء رفع الملف
        </div>
      `;
      showError('حدث خطأ أثناء رفع الملف');
    }
  });
  
  document.getElementById('editResultForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = 'جاري الحفظ...';
    
    try {
      const formData = new FormData(e.target);
      const id = document.getElementById('editResultId').value;
      const playerPhone = document.getElementById('editPlayerPhone').value;
      
      if (!id || !playerPhone) {
        throw new Error('معرّف النتيجة ورقم الهاتف مطلوبان');
      }
      
      formData.append('id', id);
      formData.append('playerPhone', playerPhone);
      
      const playerName = document.getElementById('editPlayerName').value;
      if (playerName) {
        formData.append('playerName', playerName);
      }
      
      // لا يمكن تحديث الملف مباشرة بـ PUT/PATCH مع FormData إذا كان الملف اختياري
      // يجب أن يكون هناك endpoint منفصل لتحديث البيانات بدون ملف، وآخر لرفع ملف جديد
      // أو التعامل مع الملفات بشكل أكثر تعقيدًا في هذا الـ endpoint
      // حاليًا، هذا الكود سيعمل فقط إذا كان هناك ملف جديد يتم رفعه أو لا يوجد ملف على الإطلاق
      // إذا كان الملف موجودًا بالفعل ولم يتم اختيار ملف جديد، فلن يتم تحديثه
      
      const response = await fetch('/admin/update-result', { // ستحتاج إلى إنشاء هذا الـ endpoint في server.js
        method: 'POST', // أو PUT إذا كنت تفضل RESTful
        body: formData
      });
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || 'حدث خطأ في الخادم');
      }
      
      const data = await response.json();
      
      if (data.success) {
        document.getElementById('editResultModal').classList.add('hidden');
        showSuccess(data.message || 'تم تحديث النتيجة بنجاح');
        loadData();
      } else {
        throw new Error(data.message || 'فشل تحديث النتيجة');
      }
    } catch (error) {
      console.error('Update failed:', error);
      showError(error.message || 'حدث خطأ أثناء تحديث النتيجة');
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = 'حفظ التعديلات';
    }
  });
  
  document.getElementById('respondInquiryForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const id = document.getElementById('respondInquiryId').value;
    const response = document.getElementById('inquiryResponse').value;
    
    try {
      const res = await fetch(`/admin/update-inquiry/${id}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ status: 'responded', response })
      });
      
      const data = await res.json();
      
      if (data.success) {
        document.getElementById('respondInquiryModal').classList.add('hidden');
        document.getElementById('inquiryResponse').value = '';
        showSuccess('تم إرسال الرد بنجاح');
        loadData();
      } else {
        showError(data.message || 'حدث خطأ أثناء إرسال الرد');
      }
    } catch (error) {
      console.error('Error responding to inquiry:', error);
      showError('حدث خطأ أثناء إرسال الرد');
    }
  });
  
  document.getElementById('confirmDeleteBooking').addEventListener('click', async () => {
    const id = document.getElementById('deleteBookingId').value;
    
    try {
      const response = await fetch(`/admin/delete-booking/${id}`, {
        method: 'DELETE'
      });
      const data = await response.json();
      
      if (data.success) {
        document.getElementById('deleteBookingModal').classList.add('hidden');
        showSuccess('تم حذف الطلب بنجاح');
        loadData();
      } else {
        showError(data.message || 'حدث خطأ أثناء حذف الطلب');
      }
    } catch (error) {
      console.error('Error deleting booking:', error);
      showError('حدث خطأ أثناء حذف الطلب');
    }
  });
  
  document.getElementById('confirmDeleteInquiry').addEventListener('click', async () => {
    const id = document.getElementById('deleteInquiryId').value;
    
    try {
      const response = await fetch(`/admin/delete-inquiry/${id}`, {
        method: 'DELETE'
      });
      const data = await response.json();
      
      if (data.success) {
        document.getElementById('deleteInquiryModal').classList.add('hidden');
        showSuccess('تم حذف الاستفسار بنجاح');
        loadData();
      } else {
        showError(data.message || 'حدث خطأ أثناء حذف الاستفسار');
      }
    } catch (error) {
      console.error('Error deleting inquiry:', error);
      showError('حدث خطأ أثناء حذف الاستفسار');
    }
  });
  
  document.getElementById('closeBookingModal').addEventListener('click', () => {
    document.getElementById('editBookingModal').classList.add('hidden');
  });
  
  document.getElementById('cancelBookingEdit').addEventListener('click', () => {
    document.getElementById('editBookingModal').classList.add('hidden');
  });
  
  document.getElementById('cancelDeleteBooking').addEventListener('click', () => {
    document.getElementById('deleteBookingModal').classList.add('hidden');
  });
  
  document.getElementById('closeInquiryModal').addEventListener('click', () => {
    document.getElementById('respondInquiryModal').classList.add('hidden');
  });
  
  document.getElementById('cancelInquiryResponse').addEventListener('click', () => {
    document.getElementById('respondInquiryModal').classList.add('hidden');
  });
  
  document.getElementById('cancelDeleteInquiry').addEventListener('click', () => {
    document.getElementById('deleteInquiryModal').classList.add('hidden');
  });
  
  document.getElementById('closeResultModal').addEventListener('click', () => {
    document.getElementById('editResultModal').classList.add('hidden');
  });
  
  document.getElementById('cancelResultEdit').addEventListener('click', () => {
    document.getElementById('editResultModal').classList.add('hidden');
  });
  
  document.getElementById('logoutBtn').addEventListener('click', async (e) => {
    e.preventDefault();
    
    try {
      const response = await fetch('/admin/logout');
      const data = await response.json();
      
      if (data.success) {
        window.location.href = '/login.html'; // تم تغيير المسار هنا
      }
    } catch (error) {
      console.error('Logout error:', error);
      showError('حدث خطأ أثناء تسجيل الخروج');
    }
  });
  
  checkSession();
    
    // عرض اسم الملف عند اختياره
    document.getElementById('resultFile').addEventListener('change', function(e) {
      const fileName = e.target.files[0] ? e.target.files[0].name : 'لم يتم اختيار ملف';
      document.getElementById('fileName').textContent = fileName;
    });
    
    document.getElementById('editResultFile').addEventListener('change', function(e) {
      const fileName = e.target.files[0] ? e.target.files[0].name : 'لم يتم اختيار ملف';
      document.getElementById('editFileName').textContent = fileName;
    });

    // إدارة قسم الدرجات
    document.addEventListener('DOMContentLoaded', function() {
      // إضافة حدث للنقر على زر إضافة درجة
      document.getElementById('addGradeBtn').addEventListener('click', function() {
        document.getElementById('gradeModalTitle').textContent = 'إضافة درجة جديدة';
        document.getElementById('gradeForm').reset();
        document.getElementById('gradeId').value = '';
        document.getElementById('gradeModal').classList.remove('hidden');
      });

      // إغلاق مودال الدرجات
      document.getElementById('closeGradeModal').addEventListener('click', function() {
        document.getElementById('gradeModal').classList.add('hidden');
      });

      document.getElementById('cancelGrade').addEventListener('click', function() {
        document.getElementById('gradeModal').classList.add('hidden');
      });

      // حفظ بيانات الدرجة
      document.getElementById('gradeForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const gradeData = {
          id: document.getElementById('gradeId').value, // سيتم تحديده بواسطة الخادم لـ uuid
          name: document.getElementById('studentName').value,
          phone: document.getElementById('studentPhone').value,
          email: document.getElementById('studentEmail').value,
          score: parseInt(document.getElementById('grade').value),
          total: parseInt(document.getElementById('total').value),
          answers: JSON.stringify({}) // لا توجد إجابات مفصلة هنا، فقط النتيجة
        };

        try {
          const response = await fetch('/api/submit-quiz', { // استخدام نفس endpoint إرسال الاختبار
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(gradeData)
          });
          
          const data = await response.json();
          
          if (data.success) {
            showSuccess('تم حفظ بيانات الدرجة بنجاح');
            document.getElementById('gradeModal').classList.add('hidden');
            loadData(); // إعادة تحميل البيانات لتحديث جدول الدرجات
          } else {
            showError(data.message || 'حدث خطأ أثناء حفظ الدرجة');
          }
        } catch (error) {
          console.error('Error saving grade:', error);
          showError('حدث خطأ أثناء حفظ الدرجة');
        }
      });

      // تصدير بيانات الدرجات
      document.getElementById('exportGradesBtn').addEventListener('click', function() {
        // هنا يمكنك إضافة كود لتصدير البيانات كملف Excel أو CSV
        alert('سيتم تصدير بيانات الدرجات كملف Excel');
      });
    });

    // دالة لتحديث جدول الدرجات
    function updateGradesTable(quizzes) {
      const gradesTable = document.getElementById('gradesTable');
      gradesTable.innerHTML = '';

      if (quizzes.length === 0) {
        gradesTable.innerHTML = `
          <tr>
            <td colspan="7" class="px-4 py-4 text-center text-gray-500 dark:text-gray-400">لا توجد بيانات متاحة</td>
          </tr>
        `;
        document.getElementById('gradesCount').textContent = 0;
        document.getElementById('totalGradesCount').textContent = 0;
        return;
      }

      quizzes.forEach((quiz, index) => {
        const percentage = (quiz.score / quiz.total) * 100;
        let gradeClass = 'grade-poor';
        
        if (percentage >= 85) gradeClass = 'grade-excellent';
        else if (percentage >= 70) gradeClass = 'grade-good';
        else if (percentage >= 50) gradeClass = 'grade-average';
        
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50 dark:hover:bg-gray-600';
        row.innerHTML = `
          <td class="px-4 py-4 text-sm text-gray-700 dark:text-gray-300">${index + 1}</td>
          <td class="px-4 py-4 text-sm font-medium text-gray-800 dark:text-gray-200">${quiz.name}</td>
          <td class="px-4 py-4 text-sm">
            <span class="grade-badge ${gradeClass}">${quiz.score}/${quiz.total} (${percentage.toFixed(1)}%)</span>
          </td>
          <td class="px-4 py-4 text-sm text-gray-700 dark:text-gray-300">${quiz.phone}</td>
          <td class="px-4 py-4 text-sm text-gray-700 dark:text-gray-300">${quiz.email || 'غير متوفر'}</td>
          <td class="px-4 py-4 text-sm text-gray-700 dark:text-gray-300">${new Date(quiz.submittedAt).toLocaleDateString('ar-EG')}</td>
          <td class="px-4 py-4 text-sm text-right space-x-2">
            <button class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-900 dark:hover:text-indigo-300 edit-grade" data-id="${quiz.id}">
              <i class="fas fa-edit"></i>
            </button>
            <button class="text-red-600 dark:text-red-400 hover:text-red-900 dark:hover:text-red-300 delete-grade" data-id="${quiz.id}">
              <i class="fas fa-trash-alt"></i>
            </button>
          </td>
        `;
        gradesTable.appendChild(row);
      });

      document.getElementById('gradesCount').textContent = quizzes.length;
      document.getElementById('totalGradesCount').textContent = quizzes.length;
      
      // إضافة مستمعي الأحداث لأزرار التعديل والحذف
      document.querySelectorAll('.edit-grade').forEach(button => {
        button.addEventListener('click', (e) => {
          const id = e.currentTarget.getAttribute('data-id');
          const quizToEdit = quizzes.find(q => q.id === id);
          if (quizToEdit) {
            document.getElementById('gradeModalTitle').textContent = 'تعديل درجة';
            document.getElementById('gradeId').value = quizToEdit.id;
            document.getElementById('studentName').value = quizToEdit.name;
            document.getElementById('grade').value = quizToEdit.score;
            document.getElementById('total').value = quizToEdit.total;
            document.getElementById('studentPhone').value = quizToEdit.phone;
            document.getElementById('studentEmail').value = quizToEdit.email;
            document.getElementById('gradeModal').classList.remove('hidden');
          }
        });
      });

      document.querySelectorAll('.delete-grade').forEach(button => {
        button.addEventListener('click', async (e) => {
          const id = e.currentTarget.getAttribute('data-id');
          if (confirm('هل أنت متأكد من حذف هذه الدرجة؟')) {
            try {
              const response = await fetch(`/admin/delete-quiz-result/${id}`, { // ستحتاج إلى إنشاء هذا الـ endpoint
                method: 'DELETE'
              });
              const data = await response.json();
              if (data.success) {
                showSuccess('تم حذف الدرجة بنجاح');
                loadData(); // إعادة تحميل البيانات لتحديث الجدول
              } else {
                showError(data.message || 'حدث خطأ أثناء حذف الدرجة');
              }
            } catch (error) {
              console.error('Error deleting quiz result:', error);
              showError('حدث خطأ أثناء حذف الدرجة');
            }
          }
        });
      });
    }

    // وظائف التحكم في الامتحان
    async function checkQuizStatus() {
      try {
        const response = await fetch('/admin/quiz-status');
        const data = await response.json();
        const quizStatusElement = document.getElementById('quizStatus');
        if (data.isOpen) {
          quizStatusElement.textContent = 'مفتوح';
          quizStatusElement.classList.remove('text-red-500');
          quizStatusElement.classList.add('text-green-500');
        } else {
          quizStatusElement.textContent = 'مغلق';
          quizStatusElement.classList.remove('text-green-500');
          quizStatusElement.classList.add('text-red-500');
        }
      } catch (error) {
        console.error('Error fetching quiz status:', error);
        document.getElementById('quizStatus').textContent = 'خطأ في التحميل';
        document.getElementById('quizStatus').classList.add('text-red-500');
      }
    }

    async function setQuizStatus(isOpen) {
      try {
        const response = await fetch('/admin/set-quiz-status', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ isOpen })
        });
        const data = await response.json();
        const responseDiv = document.getElementById('quizControlResponse');
        responseDiv.classList.remove('hidden');
        if (data.success) {
          responseDiv.innerHTML = `
            <div class="bg-green-100 dark:bg-green-900 border border-green-400 dark:border-green-700 text-green-700 dark:text-green-200 px-4 py-3 rounded">
              ${data.message}
            </div>
          `;
          showSuccess(data.message);
          checkQuizStatus(); // تحديث الحالة المعروضة
        } else {
          responseDiv.innerHTML = `
            <div class="bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-700 text-red-700 dark:text-red-200 px-4 py-3 rounded">
              ${data.message}
            </div>
          `;
          showError(data.message);
        }
      } catch (error) {
        console.error('Error setting quiz status:', error);
        const responseDiv = document.getElementById('quizControlResponse');
        responseDiv.classList.remove('hidden');
        responseDiv.innerHTML = `
          <div class="bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-700 text-red-700 dark:text-red-200 px-4 py-3 rounded">
            حدث خطأ أثناء تحديث حالة الامتحان.
          </div>
        `;
        showError('حدث خطأ أثناء تحديث حالة الامتحان.');
      }
    }

    document.getElementById('openQuizBtn').addEventListener('click', () => setQuizStatus(true));
    document.getElementById('closeQuizBtn').addEventListener('click', () => setQuizStatus(false));

  </script>
</body>
</html>
